# Scouter OCR改善計画（日本語スクリーンショット向け・改訂版）

このドキュメントは、以下の3課題を前提に「実際に開発へ落とせる計画」に修正したものです。

1. Tesseractはスクリーンショット（低DPI）に根本的に不利。
2. 現在の前処理（3モード）は二値化中心で、日本語細字やカラーUIに弱い。
3. `config.ini` 不在時の言語フォールバックが `eng` で、日本語認識が失敗しやすい。

---

## 1. ゴール（成果物ベース）

### 必達ゴール
- 日本語UIスクショで現行比 **CER 30%以上改善**。
- 数値モード（計算・表）で **合計値一致率95%以上**。
- CPU環境での平均処理時間を **現行2.5倍以内** に維持。

### 成果物
- OCRエンジン抽象化層（Tesseract/EasyOCR切替可能）
- EasyOCR実装（`ja+en`）
- 前処理パイプライン再設計（非二値化優先 + 条件分岐）
- 評価スクリプト（CER/WER/数値一致率/速度）
- 既定設定見直し（日本語優先）

---

## 2. 方針（中コスト・最大効果）

## 2.1 OCRエンジン置換/併用を主軸にする
Tesseract改善だけでは限界があるため、**EasyOCRを第一候補で導入**し、Tesseractは互換用として残す。

### EasyOCR採用理由
- 日本語・英語混在に強い。
- スクリーンショット系データへの耐性が高い。
- 前処理依存がTesseractより小さい。
- GPUなしCPUでも動作可能（初回モデルDLあり）。

### 導入メモ
```bash
pip install easyocr
```

```python
import easyocr

reader = easyocr.Reader(['ja', 'en'], gpu=False)
results = reader.readtext(image_array)
# results: [[bbox, text, confidence], ...]
```

> 初回起動時にモデルダウンロード（数百MB）が発生するため、
> オフライン配布向けに「初回セットアップ手順」を別紙化する。

---

## 3. 技術設計（実装単位）

## 3.1 OCRインターフェース統一
`scouter.py` 内に直接分散しているOCR呼び出しを、次の構造に寄せる。

- `OCREngine`（抽象）
  - `recognize(image, mode) -> OCRResult`
- `TesseractEngine`
- `EasyOCREngine`
- `OCRResult`
  - `text`, `confidence`, `engine`, `meta`

これにより「エンジン比較」「フォールバック」「A/B計測」を実装しやすくする。

## 3.2 実行戦略
- デフォルト: EasyOCR
- フォールバック: EasyOCR失敗時のみTesseract再試行
- モード別最適化:
  - テキスト抽出: EasyOCR優先
  - 計算/表: EasyOCR結果 + 数値後処理強化

---

## 4. 前処理の見直し（スクショ向け）

## 4.1 現行課題
現状は拡大 + 強コントラスト + 二値化寄りで、
アンチエイリアス付き日本語フォントの線を壊しやすい。

## 4.2 新方針
- **二値化は最終手段**（常時適用しない）
- カラー/グレースケール情報を保持したまま認識を優先
- 画像特性に応じて軽量分岐

### 新プリセット案
1. `screen_default`
   - 2x拡大（Lanczos）
   - 軽いシャープ化
   - 非二値化
2. `screen_low_contrast`
   - CLAHE
   - 軽いデノイズ
   - 非二値化
3. `screen_dot_font`
   - 3x拡大（Nearest）
   - Otsu（二値化）
4. `legacy_tesseract_bin`
   - 既存互換の二値化系

---

## 5. 設定の是正（即対応）

## 5.1 言語フォールバック
- 現状: `eng`
- 変更: **`jpn` を既定**
- 推奨: UI上の初期値は `jpn+eng`

## 5.2 config不在時の動作
- 起動時に実効設定をログ出力（言語・エンジン・前処理）
- `jpn`データ未導入時は明示警告（サイレント失敗禁止）

---

## 6. 評価計画（実装と同時進行）

## 6.1 データセット
- 最低100枚（理想200枚）
- 内訳:
  - ダイアログ文面
  - 表・数値
  - 小フォント
  - ダークモード
  - 日本語英語混在

## 6.2 指標
- CER / WER
- 数値一致率
- 合計値一致率
- レイテンシ（P50/P95）

## 6.3 比較軸
1. 現行Tesseract（baseline）
2. Tesseract + 新前処理
3. EasyOCR（前処理最小）
4. EasyOCR + モード別後処理

---

## 7. 開発ロードマップ（6週間）

### Week 1: 設計と計測基盤
- OCRインターフェース導入
- 評価スクリプト作成
- ベースライン測定

### Week 2: EasyOCR統合
- `EasyOCREngine`実装
- UI設定にエンジン選択追加（内部設定でも可）
- 初回DL・エラーハンドリング整備

### Week 3: 前処理刷新
- 新プリセット4種を実装
- モード別既定値調整

### Week 4: 後処理強化
- 数値向け正規化（`O/0`, `l/1`, `ー/-` など）
- 全半角統一、空白整理

### Week 5: チューニング
- エンジン×前処理の最適組合せ探索
- 誤認識パターンに対する補正ルール追加

### Week 6: 仕上げ
- 既定設定確定（日本語優先）
- ドキュメント更新
- リリース判定（Go/No-Go）

---

## 8. リスクと対策
- **初回モデルDLが重い**: 初回セットアップ手順明記、キャッシュ案内。
- **CPUで遅いケース**: 画像サイズ上限、モード別軽量設定を用意。
- **誤認識のゆらぎ**: 信頼度しきい値 + 再試行条件を明確化。

---

## 9. 直近タスク（着手順）
1. `language` のデフォルトを `jpn` に変更（ドキュメント・コード）。
2. OCRエンジン抽象化層を追加。
3. EasyOCRをPoC実装し、baseline比較を実施。
4. 前処理プリセットを新設し、二値化常用を廃止。
5. 数値モード後処理を追加し、合計値一致率を計測。

この順序なら、**最小の手戻りで最大の精度改善**を狙えます。
